<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f1115">
<title>Patdraw</title>

<!-- Ic√¥ne iOS/Android inject√©e dynamiquement (180x180) -->
<link id="appleIcon" rel="apple-touch-icon" sizes="180x180" href="">
<link id="favicon" rel="icon" type="image/png" href="">

<style>
  :root{
    --bg:#0f1115; --panel:#171a21; --text:#e8ecf3; --muted:#8b93a7;
    --accent:#3b82f6; --btn:#232735; --danger:#ef4444; --ok:#10b981;
    --shadow:0 8px 24px rgba(0,0,0,.35);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font:500 16px/1.4 -apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial;}
  .app{position:fixed; inset:0; height:100%; width:100%; display:flex; flex-direction:column;}
  .canvas-wrap{position:relative; flex:1; padding:8px;}
  .stack{position:relative; width:100%; height:100%;}
  canvas.layer, canvas.overlay{
    position:absolute; inset:0; width:100%; height:100%; display:block; border-radius:12px;
  }
  canvas.bg{background:#fff; border-radius:12px; box-shadow:var(--shadow);}
  canvas.overlay{ pointer-events:auto; }

  /* Bouton menu + mini-logo */
  .menu-toggle{
    position:fixed; left:10px; top:10px; z-index:9999;
    width:38px; height:38px; border-radius:10px; border:0; cursor:pointer;
    background:var(--panel); color:#fff; font-weight:800; font-size:18px;
    box-shadow:var(--shadow);
  }
  .brand{
    position:fixed; left:60px; top:10px; z-index:9999;
    display:flex; align-items:center; gap:8px; opacity:.92;
    background:linear-gradient(180deg,var(--panel),#12151c); padding:8px 10px; border-radius:10px;
    box-shadow:var(--shadow);
  }
  .brand svg{ width:20px; height:20px; }
  .brand span{ font-weight:700; letter-spacing:.3px; }

  .toolbar{
    position:fixed; left:10px; top:58px; right:10px; z-index:9998;
    background:linear-gradient(180deg,var(--panel),#12151c);
    border-radius:14px; padding:10px; display:none; box-shadow:var(--shadow);
  }
  .toolbar.open{ display:block; }
  .row{display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin-bottom:8px;}
  .btn{
    appearance:none; border:0; border-radius:10px; padding:10px 12px;
    background:var(--btn); color:#fff; font-weight:600;
  }
  .btn[aria-pressed="true"]{ background:var(--accent); }
  .btn.small{ padding:6px 8px; font-size:12px }
  .btn.ok{ background:#132019; color:#b8f7dc }
  .btn.danger{ background:#2a1517; color:#ffc9c9 }
  input[type="color"]{width:42px;height:42px;border-radius:10px;border:none;padding:0;background:transparent;}
  input[type="range"]{ width:160px; }
  .hint{
    position:absolute; left:12px; bottom:12px; color:#6a7286; font-size:12px;
    background:rgba(0,0,0,.35); padding:6px 10px; border-radius:10px;
  }
  .sep{ width:1px; height:28px; background:#2a2f3f; margin:0 6px; }
</style>
</head>
<body>
  <button class="menu-toggle" id="menuToggle" aria-label="Menu">m</button>

  <!-- Mini logo Patdraw -->
  <div class="brand" aria-hidden="true">
    <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img">
      <defs>
        <linearGradient id="g" x1="0" x2="1">
          <stop offset="0" stop-color="#3b82f6"/><stop offset="1" stop-color="#10b981"/>
        </linearGradient>
      </defs>
      <rect x="2" y="2" width="60" height="60" rx="14" fill="url(#g)"/>
      <path d="M22 44V18h13.5c6.5 0 11 3.7 11 9.4 0 5.6-4.5 9.2-11 9.2H30v7.4H22zm8-14.2h5.4c2.4 0 4-1.4 4-3.4 0-2.1-1.6-3.5-4-3.5H30v6.9z" fill="#fff"/>
    </svg>
    <span>Patdraw</span>
  </div>

  <div class="toolbar" id="toolbar" role="toolbar" aria-label="Outils">
    <div class="row">
      <button class="btn" id="penBtn" aria-pressed="true">üñäÔ∏è Stylo</button>
      <button class="btn" id="eraserBtn" aria-pressed="false">ü©π Gomme</button>
      <button class="btn" id="rectBtn" aria-pressed="false">‚ñ≠ Rectangle</button>
      <button class="btn" id="ellipseBtn" aria-pressed="false">‚óØ Ellipse</button>
      <button class="btn" id="fillBtn" aria-pressed="false">Remplir</button>
      <span class="sep"></span>
      <button class="btn" id="eyedropBtn" aria-pressed="false">üéØ Pipette</button>
      <button class="btn" id="loupeBtn" aria-pressed="false">üîç Loupe</button>
    </div>

    <div class="row">
      <input id="color" type="color" value="#1f2937" aria-label="Couleur" />
      <label for="size">Taille</label>
      <input id="size" type="range" min="1" max="60" step="1" value="8" />
      <span id="sizeOut">8 px</span>
      <span class="sep"></span>
      <span>Calque :</span>
      <button class="btn small" id="layer1Btn" aria-pressed="true">L1</button>
      <button class="btn small" id="eye1" aria-pressed="true">üëÅ1</button>
      <button class="btn small" id="layer2Btn" aria-pressed="false">L2</button>
      <button class="btn small" id="eye2" aria-pressed="true">üëÅ2</button>
      <button class="btn small" id="layer3Btn" aria-pressed="false">L3</button>
      <button class="btn small" id="eye3" aria-pressed="true">üëÅ3</button>
    </div>

    <div class="row">
      <button class="btn" id="undoBtn">‚Ü∂ Annuler</button>
      <button class="btn" id="redoBtn">‚Ü∑ R√©tablir</button>
      <button class="btn ok" id="saveBtn">üíæ PNG</button>
      <button class="btn danger" id="clearBtn">üóëÔ∏è Effacer tout</button>
      <button class="btn" id="closeMenuBtn">Fermer</button>
    </div>
  </div>

  <div class="app">
    <div class="canvas-wrap">
      <div class="stack" id="stack">
        <canvas class="bg layer" id="bg"></canvas>
        <canvas class="layer" id="layer1"></canvas>
        <canvas class="layer" id="layer2"></canvas>
        <canvas class="layer" id="layer3"></canvas>
        <canvas class="overlay" id="overlay"></canvas>
      </div>
      <div class="hint">Astuce : touche ‚Äúm‚Äù pour afficher/masquer le menu. Outils : Stylo, Gomme, ‚ñ≠, ‚óØ, üéØ, üîç</div>
    </div>
  </div>

<script>
/* === G√©n√©ration automatique de l'ic√¥ne (180x180) + favicon === */
(function(){
  function makeIcon(size){
    var c=document.createElement('canvas'), x=c.getContext('2d'); c.width=c.height=size;
    // fond d√©grad√©
    var g=x.createLinearGradient(0,0,size,size);
    g.addColorStop(0,"#3b82f6"); g.addColorStop(1,"#10b981");
    x.fillStyle=g; x.fillRect(0,0,size,size);
    // arrondis
    x.globalCompositeOperation="destination-in";
    x.beginPath(); var r=size*0.2; // rayon de coin
    x.moveTo(r,0); x.arcTo(size,0,size,size,r); x.arcTo(size,size,0,size,r); x.arcTo(0,size,0,0,r); x.arcTo(0,0,size,0,r); x.closePath(); x.fill();
    x.globalCompositeOperation="source-over";
    // lettre P stylis√©e
    x.fillStyle="#fff"; x.save();
    x.translate(size*0.22,size*0.22); x.scale(size/180,size/180);
    // mot P comme dans le mini-logo
    x.beginPath();
    // tige
    x.rect(0,0,30,100);
    // boucle
    x.moveTo(30,0);
    x.lineTo(65,0); x.quadraticCurveTo(110,0,110,35);
    x.quadraticCurveTo(110,70,65,70); x.lineTo(30,70); x.closePath();
    x.fill(); x.restore();
    return c.toDataURL("image/png");
  }
  var icon180 = makeIcon(180);
  var fav32 = makeIcon(64); // √ßa donne un joli favicon

  var linkApple = document.getElementById('appleIcon');
  var linkFav = document.getElementById('favicon');
  if(linkApple) linkApple.href = icon180;
  if(linkFav) linkFav.href = fav32;
})();

/* === Appli Patdraw (V2 fix : loupe, pipette, formes, 3 calques) === */
(function(){
  // ---------- Elements ----------
  var bg = document.getElementById('bg');
  var l1 = document.getElementById('layer1');
  var l2 = document.getElementById('layer2');
  var l3 = document.getElementById('layer3');
  var overlay = document.getElementById('overlay');
  var layers = [l1,l2,l3];

  var menuToggle = document.getElementById('menuToggle');
  var toolbar = document.getElementById('toolbar');
  var closeMenuBtn = document.getElementById('closeMenuBtn');

  var penBtn = document.getElementById('penBtn');
  var eraserBtn = document.getElementById('eraserBtn');
  var rectBtn = document.getElementById('rectBtn');
  var ellipseBtn = document.getElementById('ellipseBtn');
  var fillBtn = document.getElementById('fillBtn');
  var eyedropBtn = document.getElementById('eyedropBtn');
  var loupeBtn = document.getElementById('loupeBtn');

  var colorInput = document.getElementById('color');
  var sizeInput = document.getElementById('size');
  var sizeOut = document.getElementById('sizeOut');

  var undoBtn = document.getElementById('undoBtn');
  var redoBtn = document.getElementById('redoBtn');
  var clearBtn = document.getElementById('clearBtn');
  var saveBtn = document.getElementById('saveBtn');

  var layer1Btn = document.getElementById('layer1Btn');
  var layer2Btn = document.getElementById('layer2Btn');
  var layer3Btn = document.getElementById('layer3Btn');
  var eye1 = document.getElementById('eye1');
  var eye2 = document.getElementById('eye2');
  var eye3 = document.getElementById('eye3');

  // ---------- Contexts ----------
  var dpr = Math.max(1, window.devicePixelRatio || 1);
  var bgx = bg.getContext('2d');
  var ctxs = [l1.getContext('2d'), l2.getContext('2d'), l3.getContext('2d')];
  var octx = overlay.getContext('2d');

  // Offscreen composite for pipette/loupe/export
  var comp = document.createElement('canvas');
  var compCtx = comp.getContext('2d');

  // ---------- State ----------
  var tool = 'pen'; // 'pen' | 'eraser' | 'rect' | 'ellipse' | 'eyedrop' | 'loupe'
  var fillShape = false;
  var activeLayer = 0; // 0..2
  var vis = [true,true,true];

  var drawing = false;
  var lastX=0, lastY=0;
  var startX=0, startY=0;

  // History: store imageData for all 3 layers
  var history = [], historyIndex = -1, HISTORY_LIMIT = 15;

  // ---------- UI helpers ----------
  function setPressed(el, on){ el.setAttribute('aria-pressed', on ? 'true':'false'); }
  function openMenu(open){ toolbar.className = open ? 'toolbar open' : 'toolbar'; }

  menuToggle.addEventListener('click', function(){
    var isOpen = toolbar.className.indexOf('open') !== -1;
    openMenu(!isOpen);
  });
  closeMenuBtn.addEventListener('click', function(){ openMenu(false); });

  function selectTool(t){
    tool = t;
    setPressed(penBtn, t==='pen');
    setPressed(eraserBtn, t==='eraser');
    setPressed(rectBtn, t==='rect');
    setPressed(ellipseBtn, t==='ellipse');
    setPressed(eyedropBtn, t==='eyedrop');
    setPressed(loupeBtn, t==='loupe');
    // Efface l'overlay de pr√©visualisation
    octx.setTransform(1,0,0,1,0,0); octx.clearRect(0,0,overlay.width,overlay.height);
  }
  penBtn.onclick = function(){ selectTool('pen'); };
  eraserBtn.onclick = function(){ selectTool('eraser'); };
  rectBtn.onclick = function(){ selectTool('rect'); };
  ellipseBtn.onclick = function(){ selectTool('ellipse'); };
  eyedropBtn.onclick = function(){ selectTool('eyedrop'); };
  loupeBtn.onclick = function(){ selectTool('loupe'); };

  fillBtn.onclick = function(){
    fillShape = !(fillBtn.getAttribute('aria-pressed')==='true');
    setPressed(fillBtn, fillShape);
  };
  sizeInput.oninput = function(){ sizeOut.textContent = sizeInput.value + ' px'; };
  sizeOut.textContent = sizeInput.value + ' px';

  function setActiveLayer(i){
    activeLayer = i;
    setPressed(layer1Btn, i===0);
    setPressed(layer2Btn, i===1);
    setPressed(layer3Btn, i===2);
  }
  layer1Btn.onclick = function(){ setActiveLayer(0); };
  layer2Btn.onclick = function(){ setActiveLayer(1); };
  layer3Btn.onclick = function(){ setActiveLayer(2); };

  eye1.onclick = function(){ toggleVis(0, eye1); };
  eye2.onclick = function(){ toggleVis(1, eye2); };
  eye3.onclick = function(){ toggleVis(2, eye3); };
  function toggleVis(i, btn){
    vis[i] = !(btn.getAttribute('aria-pressed')==='true');
    setPressed(btn, vis[i]);
    layers[i].style.display = vis[i] ? 'block' : 'none';
  }

  // ---------- Sizing ----------
  function scaleCtx(ctx){ ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr); }
  function fit(){
    var rect = bg.getBoundingClientRect();
    var w = Math.max(1, Math.round(rect.width * dpr));
    var h = Math.max(1, Math.round(rect.height * dpr));

    [bg,l1,l2,l3,overlay,comp].forEach(function(c){ c.width = w; c.height = h; });

    scaleCtx(bgx); scaleCtx(ctxs[0]); scaleCtx(ctxs[1]); scaleCtx(ctxs[2]); scaleCtx(octx);
    // fond blanc
    bgx.fillStyle = '#ffffff';
    bgx.fillRect(0,0, bg.width/dpr, bg.height/dpr);

    // reset overlay
    octx.clearRect(0,0, overlay.width, overlay.height);

    resetHistory(); // baseline (3 calques vides)
  }
  window.addEventListener('resize', function(){ dpr = Math.max(1, window.devicePixelRatio || 1); fit(); });

  // ---------- History ----------
  function snapshotAll(){
    try{
      return [
        ctxs[0].getImageData(0,0,l1.width,l1.height),
        ctxs[1].getImageData(0,0,l2.width,l2.height),
        ctxs[2].getImageData(0,0,l3.width,l3.height)
      ];
    }catch(e){ return null; }
  }
  function applySnapshot(snap){
    if (!snap) return;
    ctxs[0].putImageData(snap[0],0,0);
    ctxs[1].putImageData(snap[1],0,0);
    ctxs[2].putImageData(snap[2],0,0);
  }
  function resetHistory(){
    history = []; historyIndex = -1;
    pushHistory();
  }
  function pushHistory(){
    var snap = snapshotAll();
    if (!snap) return;
    if (historyIndex < history.length - 1){ history = history.slice(0, historyIndex+1); }
    history.push(snap);
    if (history.length > HISTORY_LIMIT){ history.shift(); } else { historyIndex++; }
    updateUndoRedo();
  }
  function updateUndoRedo(){
    undoBtn.disabled = !(historyIndex > 0);
    redoBtn.disabled = !(historyIndex < history.length - 1);
  }
  function undo(){
    if (historyIndex > 0){
      historyIndex--;
      applySnapshot(history[historyIndex]);
      octx.clearRect(0,0,overlay.width,overlay.height);
      updateUndoRedo();
    }
  }
  function redo(){
    if (historyIndex < history.length - 1){
      historyIndex++;
      applySnapshot(history[historyIndex]);
      octx.clearRect(0,0,overlay.width,overlay.height);
      updateUndoRedo();
    }
  }
  undoBtn.onclick = undo;
  redoBtn.onclick = redo;

  // ---------- Utils ----------
  function cssToCanvasCoords(x,y){
    var r = bg.getBoundingClientRect();
    return { cx: (x - r.left), cy: (y - r.top) };
  }
  function setStroke(ctx){
    ctx.lineCap='round'; ctx.lineJoin='round'; ctx.globalAlpha=1.0;
    if (tool==='eraser'){
      ctx.globalCompositeOperation='destination-out';
      ctx.strokeStyle='rgba(0,0,0,1)';
    } else {
      ctx.globalCompositeOperation='source-over';
      ctx.strokeStyle=colorInput.value;
    }
    ctx.lineWidth = Number(sizeInput.value);
  }

  function compositeTo(compCtx){
    compCtx.setTransform(1,0,0,1,0,0);
    compCtx.clearRect(0,0, comp.width, comp.height);
    compCtx.drawImage(bg,0,0);
    if (vis[0]) compCtx.drawImage(l1,0,0);
    if (vis[1]) compCtx.drawImage(l2,0,0);
    if (vis[2]) compCtx.drawImage(l3,0,0);
  }

  function pickColorAt(x,y){
    compositeTo(compCtx);
    var px = Math.round(x*dpr), py = Math.round(y*dpr);
    try{
      var data = compCtx.getImageData(px,py,1,1).data;
      var r = data[0], g = data[1], b = data[2];
      var hex = '#'+[r,g,b].map(function(v){ var s=v.toString(16); return s.length===1?'0'+s:s; }).join('');
      colorInput.value = hex;
      return hex;
    }catch(e){ return null; }
  }

  // ---------- Touch / Mouse via OVERLAY ----------
  function touchStart(e){
    if (!e.changedTouches || !e.changedTouches.length) return;
    e.preventDefault();
    var p = cssToCanvasCoords(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
    lastX = p.cx; lastY = p.cy; startX = p.cx; startY = p.cy;
    drawing = true;

    if (tool==='pen' || tool==='eraser'){
      var ctx = ctxs[activeLayer];
      setStroke(ctx);
      ctx.beginPath(); ctx.moveTo(lastX,lastY); ctx.lineTo(lastX+0.01,lastY); ctx.stroke();
    } else if (tool==='eyedrop'){
      var picked = pickColorAt(p.cx, p.cy);
      octx.clearRect(0,0,overlay.width,overlay.height);
      if (picked){
        octx.save(); scaleCtx(octx);
        octx.beginPath(); octx.arc(p.cx, p.cy, 16, 0, Math.PI*2); octx.fillStyle=picked; octx.fill();
        octx.lineWidth=2; octx.strokeStyle='#fff'; octx.stroke();
        octx.restore();
      }
      drawing = false;
    } else if (tool==='loupe'){
      drawLoupe(p.cx, p.cy);
    } else {
      octx.clearRect(0,0,overlay.width,overlay.height);
    }
  }
  function touchMove(e){
    if (!e.changedTouches || !e.changedTouches.length) return;
    if (!drawing && tool!=='loupe') return;
    e.preventDefault();
    var p = cssToCanvasCoords(e.changedTouches[0].clientX, e.changedTouches[0].clientY);

    if (tool==='pen' || tool==='eraser'){
      var ctx = ctxs[activeLayer];
      setStroke(ctx);
      ctx.beginPath();
      ctx.moveTo(lastX,lastY); ctx.lineTo(p.cx,p.cy); ctx.stroke();
      lastX = p.cx; lastY = p.cy;
    } else if (tool==='rect' || tool==='ellipse'){
      octx.setTransform(1,0,0,1,0,0); octx.scale(dpr,dpr);
      octx.clearRect(0,0, overlay.width/dpr, overlay.height/dpr);
      drawShape(octx, startX, startY, p.cx, p.cy, colorInput.value, Number(sizeInput.value), fillShape, tool);
    } else if (tool==='loupe'){
      drawLoupe(p.cx, p.cy);
    }
  }
  function touchEnd(e){
    if (!drawing && tool!=='loupe') return;
    e.preventDefault();

    if (tool==='pen' || tool==='eraser'){
      drawing = false;
      pushHistory();
    } else if (tool==='rect' || tool==='ellipse'){
      var ctx = ctxs[activeLayer];
      var p = cssToCanvasCoords(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
      drawShape(ctx, startX, startY, p.cx, p.cy, colorInput.value, Number(sizeInput.value), fillShape, tool);
      octx.clearRect(0,0, overlay.width, overlay.height);
      drawing = false;
      pushHistory();
    } else if (tool==='loupe'){
      octx.clearRect(0,0, overlay.width, overlay.height);
      drawing = false;
    }
  }

  // Souris (tests desktop)
  overlay.addEventListener('mousedown', function(e){
    var te = { changedTouches: [{ clientX:e.clientX, clientY:e.clientY }] };
    touchStart({ changedTouches: te.changedTouches, preventDefault:function(){} });
    function move(ev){ touchMove({ changedTouches:[{clientX:ev.clientX, clientY:ev.clientY}], preventDefault:function(){} }); }
    function up(ev){
      touchEnd({ changedTouches:[{clientX:ev.clientX, clientY:ev.clientY}], preventDefault:function(){} });
      window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up);
    }
    window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
  });

  // Tactile via overlay
  overlay.addEventListener('touchstart',  touchStart, {passive:false});
  overlay.addEventListener('touchmove',   touchMove,  {passive:false});
  overlay.addEventListener('touchend',    touchEnd,   {passive:false});
  overlay.addEventListener('touchcancel', touchEnd,   {passive:false});

  // ---------- Shapes / Loupe ----------
  function drawShape(ctx, x0,y0,x1,y1, color, lineW, fill, kind){
    var left = Math.min(x0,x1), top = Math.min(y0,y1);
    var w = Math.abs(x1-x0), h = Math.abs(y1-y0);
    ctx.save(); scaleCtx(ctx);
    ctx.lineWidth = lineW; ctx.strokeStyle = color; ctx.fillStyle = color;
    ctx.globalCompositeOperation = 'source-over';
    if (kind==='rect'){
      if (fill) ctx.fillRect(left, top, w, h);
      ctx.strokeRect(left, top, w, h);
    } else { // ellipse
      ctx.beginPath();
      if (ctx.ellipse){
        ctx.ellipse(left + w/2, top + h/2, Math.max(w/2,0.1), Math.max(h/2,0.1), 0, 0, Math.PI*2);
      } else {
        var kappa = 0.5522848, ox = (w/2)*kappa, oy = (h/2)*kappa, xe = left+w, ye = top+h, xm = left+w/2, ym = top+h/2;
        ctx.moveTo(left, ym);
        ctx.bezierCurveTo(left, ym-oy, xm-ox, top, xm, top);
        ctx.bezierCurveTo(xm+ox, top, xe, ym-oy, xe, ym);
        ctx.bezierCurveTo(xe, ym+oy, xm+ox, ye, xm, ye);
        ctx.bezierCurveTo(xm-ox, ye, left, ym+oy, left, ym);
      }
      if (fill) ctx.fill();
      ctx.stroke();
    }
    ctx.restore();
  }

  function drawLoupe(x,y){
    compositeTo(compCtx);
    var radius = 60; var zoom = 2;
    octx.setTransform(1,0,0,1,0,0); octx.scale(dpr,dpr);
    octx.clearRect(0,0, overlay.width/dpr, overlay.height/dpr);

    octx.save();
    octx.beginPath(); octx.arc(x,y,radius,0,Math.PI*2); octx.clip();

    var sx = (x - radius/zoom) * dpr;
    var sy = (y - radius/zoom) * dpr;
    var sw = (2*radius/zoom) * dpr;
    var sh = (2*radius/zoom) * dpr;

    octx.drawImage(comp, sx, sy, sw, sh, x - radius, y - radius, 2*radius, 2*radius);
    octx.restore();

    octx.beginPath();
    octx.arc(x,y,radius,0,Math.PI*2);
    octx.lineWidth = 3;
    octx.strokeStyle = '#ffffff';
    octx.stroke();

    octx.beginPath(); octx.arc(x,y,2,0,Math.PI*2);
    octx.fillStyle='#ffffff'; octx.fill();
  }

  // ---------- Actions ----------
  clearBtn.onclick = function(){
    if (!confirm('Effacer tous les calques ?')) return;
    [0,1,2].forEach(function(i){
      ctxs[i].setTransform(1,0,0,1,0,0); ctxs[i].scale(dpr,dpr);
      ctxs[i].clearRect(0,0,layers[i].width, layers[i].height);
    });
    octx.clearRect(0,0,overlay.width,overlay.height);
    pushHistory();
  };

  saveBtn.onclick = function(){
    // Export PNG : fond blanc + calques visibles
    var ex = document.createElement('canvas');
    ex.width = bg.width; ex.height = bg.height;
    var exctx = ex.getContext('2d');
    exctx.fillStyle = '#ffffff'; exctx.fillRect(0,0,ex.width,ex.height);
    if (vis[0]) exctx.drawImage(l1,0,0);
    if (vis[1]) exctx.drawImage(l2,0,0);
    if (vis[2]) exctx.drawImage(l3,0,0);
    var link = document.createElement('a');
    var ts = new Date().toISOString().replace(/[:.]/g,'-');
    link.download = 'patdraw-'+ts+'.png';
    link.href = ex.toDataURL('image/png');
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
  };

  // Raccourci clavier ‚Äúm‚Äù
  window.addEventListener('keydown', function(e){
    if (e.key && (e.key==='m' || e.key==='M')){
      var isOpen = toolbar.className.indexOf('open') !== -1;
      openMenu(!isOpen);
    }
  });

  // ---------- Init ----------
  setTimeout(function(){
    var rect = document.getElementById('stack').getBoundingClientRect();
    [bg,l1,l2,l3,overlay,comp].forEach(function(c){
      c.style.width = '100%'; c.style.height='100%';
      c.width = Math.max(1, Math.round(rect.width * dpr));
      c.height = Math.max(1, Math.round(rect.height * dpr));
    });
    scaleCtx(bgx); scaleCtx(ctxs[0]); scaleCtx(ctxs[1]); scaleCtx(ctxs[2]); scaleCtx(octx);
    bgx.fillStyle = '#ffffff'; bgx.fillRect(0,0, bg.width/dpr, bg.height/dpr);
    resetHistory();
  }, 0);

})();
</script>
</body>
</html>